#!/bin/bash
set -euo pipefail

BUILD_DIR=${1}
CACHE_DIR=${2}
DEPS_DIR=${3}
DEPS_IDX=${4}

echo "Build DIR: ${BUILD_DIR}"
echo "CACHE_DIR: ${CACHE_DIR}"
echo "DEPS_DIR: ${DEPS_DIR}"
echo "DEPS_IDX ${DEPS_IDX}"

JMETER_VERSION=apache-jmeter-5.5
JMETER_DIR="${DEPS_DIR}/${JMETER_VERSION}"

# Download JMeter.
# The version is hardcoded for now, I'm not sure how to handle passing of values from user
if [ ! -f "${CACHE_DIR}/${JMETER_VERSION}.tgz" ]; then
  echo "--> Downloading ${JMETER_VERSION}"
  curl -L "https://archive.apache.org/dist/jmeter/binaries/${JMETER_VERSION}.tgz" -o "${CACHE_DIR}/${JMETER_VERSION}.tgz"
fi

# Extract JMeter to deps dir
if [ ! -d "${JMETER_DIR}" ]; then
  echo "-->Extracting JMeter"
  tar -xzf "${CACHE_DIR}/${JMETER_VERSION}.tgz" -C "${DEPS_DIR}"
fi

# If lib folder exist, copy to JMeter lib folder
if [ -d "${BUILD_DIR}/lib" ]; then
  echo "--> Copying lib folder to JMeter"
  cp -r "${BUILD_DIR}/lib/" "${JMETER_DIR}/lib"
fi

chmod -R 744 "${JMETER_DIR}/lib/"
chmod -R 744 "${JMETER_DIR}/bin/"

mkdir -p "${BUILD_DIR}/.profile.d"

# startup.sh - export env vars for app to consume at start up
STARTUP_SCRIPT="${BUILD_DIR}/.profile.d/startup.sh"
echo "export JMETER_DIR=/home/vcap/deps/${JMETER_VERSION}" > "${STARTUP_SCRIPT}"
echo "export PATH=/home/vcap/deps/${JMETER_VERSION}/bin:${PATH}" >> "${STARTUP_SCRIPT}"
